---
title: "Leaf Collection"
author: "Ed Rogers"
date: "December 22, 2015"
output: html_document
---


Load libraries and import the data
```{r importData, message=FALSE, warning=FALSE}
library(tidyr)
library(dplyr)
library(reshape2)
library(FSA)
library(lazyeval)
library(bizdays)
library(timeDate)
leafData <- read.csv("~/Documents/LeafCollection/mapStatuses.csv")
leafData <- leafData[,-which(names(leafData) == "District")]
leafData <- leafData %>% dcast(Time.Stamp ~ Area,value.var="Status")

# Remove consecutive duplicate entries (ignoring differences in timestamp)

#leafData <- leafData[!duplicated(leafData[-1]),] #This doesn't constrain itself to removing *consecutive* duplicates

leafData[is.na(leafData)] <- "NA"
leafData <- leafData[c(TRUE,rowMeans(tail(leafData[,-1],-1) != head(leafData[,-1],-1))>0),]
leafData[leafData=="NA"] <- NA

# Make the timestamp readable
leafData$Time.Stamp <- as.POSIXct(leafData$Time.Stamp,
                                  origin = "1970-01-01",
                                  tz="America/Chicago")

TimeStamps <- leafData$Time.Stamp
# data(holidaysANBIMA)
# cal <- Calendar(holidaysANBIMA, weekdays=c("saturday", "sunday"))
cal <- Calendar(holidayNYSE(2015),weekdays = c("saturday","sunday"))
dates <- data.frame(head(TimeStamps,-1))
colnames(dates) <- "left"
dates$right <- TimeStamps[-1]
datePattern <- "^.*([0-9]{4,4}-[0-9]{2,2}-[0-9]{2,2}).*$"
dates$left <- gsub(datePattern,"\\1",dates[,"left"])
dates$right<- gsub(datePattern,"\\1",dates[,"right"])
dates <- dates %>% mutate(bizDiff = bizdays(left,right,cal))
# 
# BusinessDays <- bizdays(head(TimeStamps,-1),TimeStamps[-1],cal)
dTS <- data.frame(TimeStamps)
dTS$BusinessDaysTilNextEntry <- c(dates[,"bizDiff"],0)

# #Add a column for collection round
# leafData$Area10_1_collectionRound = cumsum((leafData$Area10_1 != "Current") * (head(c("Current",leafData$Area10_1),-1) == "Current"))

leafData <- leafData[,c("Area10_1","Area2_1","Area4_1")]

# Add a column for collection round for each area
leafDataZones <- names(leafData)
leafDataNDaysNames <- names(leafData)
leafDataZones <- setNames(leafDataZones,paste0("collectionRound_",leafDataZones))
leafData <- leafData %>% 
            mutate_each_(funs(cumsum((. != "Current") * (head(c("Current",.),-1) == "Current"))),leafDataZones) 

# Group_by collection round then mutate a cumsum of "!= Current" to get "nDaysTilPickup"

# The columns of data that aren't collection rounds
leafStatus <- leafData[,-grep("^collectionRound",names(leafData))]

leafDataNDaysNames <- setNames(leafDataNDaysNames,paste0("NDaysTilCollection_",leafDataNDaysNames))

# _sd cols are just a kludge to deal with mutate_each issues
leafData <- leafData %>%
              mutate_each(funs(nDaysTilPickup=as.numeric(. != "Current"),sd=is.na),starts_with("Area"))
leafData <- leafData %>%
  select(-contains("_sd"))

# # This line could do it one-at-a-time:
# leafData <- leafData %>%
#               group_by(collectionRound_Area10_1) %>%
#               mutate(Area10_1_nDaysTilPickup = rcumsum(Area10_1_nDaysTilPickup)) %>%
#               ungroup()

leafDataNDaysCols <- leafData %>%
                      select(ends_with("nDaysTilPickup"))
leafDataNDaysCols <- names(leafDataNDaysCols)

for (col in names(leafStatus))
# for (col in c("Area10_1"))
{
  rnd <- paste0("collectionRound_",col)
  ndays <- paste0(col,"_nDaysTilPickup")
  print(c(rnd,ndays))
  leafData <- leafData %>%
                    group_by_(paste(rnd)) %>%
                    mutate_(ndays=interp(~rcumsum(ndays),ndays=as.name(ndays))) %>%
                    ungroup()
  leafData[[ndays]]=leafData$ndays
  leafData <- leafData %>% select(-ndays)
}
leafData <- leafData %>% select(-starts_with("collectionRound_"))

```